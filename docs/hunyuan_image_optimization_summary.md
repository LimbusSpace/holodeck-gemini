# æ··å…ƒå›¾åƒ3.0å®¢æˆ·ç«¯ä¼˜åŒ–æ€»ç»“

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

ä¸ºäº†è§£å†³æ··å…ƒå›¾åƒ3.0 APIçš„å¹¶å‘é™åˆ¶é—®é¢˜ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªä¼˜åŒ–ç‰ˆæœ¬çš„å®¢æˆ·ç«¯ï¼Œæä¾›äº†æ™ºèƒ½å¹¶å‘æ§åˆ¶ã€è‡ªåŠ¨é‡è¯•æœºåˆ¶å’Œæ‰¹é‡å¤„ç†åŠŸèƒ½ã€‚

## ğŸ¯ æ ¸å¿ƒé—®é¢˜è§£å†³

### åŸæœ‰é—®é¢˜
1. **å¹¶å‘é™åˆ¶**: è…¾è®¯äº‘APIæœ‰ä¸¥æ ¼çš„å¹¶å‘é™åˆ¶
2. **ç¨‹åºå´©æºƒé£é™©**: ä¸€æ¬¡æ€§å‘é€å¤§é‡è¯·æ±‚ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ
3. **ç¼ºä¹é‡è¯•æœºåˆ¶**: ç½‘ç»œé”™è¯¯æˆ–é™æµæ—¶æ— æ³•è‡ªåŠ¨æ¢å¤
4. **æ‰¹é‡å¤„ç†å›°éš¾**: éœ€è¦æ‰‹åŠ¨ç®¡ç†å¤šä¸ªä»»åŠ¡çš„æ‰§è¡Œ

### ä¼˜åŒ–è§£å†³æ–¹æ¡ˆ
1. **ä¿¡å·é‡å¹¶å‘æ§åˆ¶**: ä½¿ç”¨ `threading.Semaphore` é™åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°
2. **è‡ªåŠ¨é‡è¯•æœºåˆ¶**: åŸºäº `tenacity` åº“å®ç°æŒ‡æ•°é€€é¿é‡è¯•
3. **æ‰¹é‡ä»»åŠ¡ç®¡ç†**: æä¾›åŒæ­¥å’Œå¼‚æ­¥æ‰¹é‡å¤„ç†æ–¹æ³•
4. **çº¿ç¨‹å®‰å…¨è®¾è®¡**: æ‰€æœ‰æ“ä½œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„

## ğŸ“¦ æ–°å¢æ–‡ä»¶

### æ ¸å¿ƒå®ç°
- `holodeck_core/image_generation/hunyuan_image_client_optimized.py` (450+ è¡Œ)
  - `HunyuanImageClientOptimized` ç±»
  - `GenerationTask` æ•°æ®ç±»
  - `GenerationResult` æ•°æ®ç±»
  - ä¾¿æ·å‡½æ•°

### æµ‹è¯•æ–‡ä»¶
- `tests/integration/test_hunyuan_optimized.py` - ä¼˜åŒ–å®¢æˆ·ç«¯é›†æˆæµ‹è¯•

### ç¤ºä¾‹æ–‡ä»¶
- `examples/hunyuan_optimized_demo.py` - ä¼˜åŒ–å®¢æˆ·ç«¯ä½¿ç”¨æ¼”ç¤º

### æ–‡æ¡£
- `docs/hunyuan_image_optimized_guide.md` - è¯¦ç»†ä½¿ç”¨æŒ‡å—

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 1. æ™ºèƒ½å¹¶å‘æ§åˆ¶

```python
# ä½¿ç”¨ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°
semaphore = threading.Semaphore(max_concurrent_jobs)

def _process_single_task(self, task):
    with semaphore:  # è·å–ä»¤ç‰Œï¼Œå¦‚æœä»¤ç‰Œç”¨å®Œåˆ™ç­‰å¾…
        # æ‰§è¡Œä»»åŠ¡
        return result
```

**ä¼˜åŠ¿**:
- é¿å…APIé™æµé”™è¯¯
- è‡ªåŠ¨æ’é˜Ÿç­‰å¾…
- å¯é…ç½®å¹¶å‘æ•°

### 2. è‡ªåŠ¨é‡è¯•æœºåˆ¶

```python
@retry(
    wait=wait_exponential(multiplier=1, min=2, max=10),
    stop=stop_after_attempt(3),
    retry=retry_if_exception_type(TencentCloudSDKException)
)
def _submit_job_with_retry(self, params):
    # æäº¤ä»»åŠ¡
    pass
```

**ä¼˜åŠ¿**:
- æŒ‡æ•°é€€é¿ç­–ç•¥
- æ™ºèƒ½é”™è¯¯è¯†åˆ«
- å¯é…ç½®é‡è¯•å‚æ•°

### 3. æ‰¹é‡ä»»åŠ¡å¤„ç†

```python
# åŒæ­¥æ‰¹é‡å¤„ç†
results = client.generate_batch_sync(tasks)

# å¼‚æ­¥æ‰¹é‡å¤„ç†
results = await client.generate_batch_async(tasks)
```

**ä¼˜åŠ¿**:
- ç®€åŒ–æ‰¹é‡æ“ä½œ
- è‡ªåŠ¨ç»“æœæ”¶é›†
- æ”¯æŒå¼‚æ­¥éé˜»å¡

### 4. æ•°æ®ç±»è®¾è®¡

```python
@dataclass
class GenerationTask:
    prompt: str
    resolution: str = "1024:1024"
    style: Optional[str] = None
    model: str = "hunyuan-pro"
    output_path: Optional[str] = None
    task_id: str = ""

@dataclass
class GenerationResult:
    task_id: str
    success: bool
    image_url: Optional[str] = None
    local_path: Optional[str] = None
    error_message: Optional[str] = None
    generation_time: float = 0.0
    job_id: Optional[str] = None
```

**ä¼˜åŠ¿**:
- ç±»å‹å®‰å…¨
- æ¸…æ™°çš„æ•°æ®ç»“æ„
- ä¾¿äºåºåˆ—åŒ–å’Œæ—¥å¿—è®°å½•

## ğŸš€ æ€§èƒ½æå‡

### å¹¶å‘æ§åˆ¶æ•ˆæœ
- **å¹¶å‘æ•°**: ä»æ— é™åˆ¶åˆ°å¯æ§ (é»˜è®¤2ä¸ªå¹¶å‘)
- **ç¨³å®šæ€§**: æ˜¾è‘—é™ä½APIé™æµé”™è¯¯
- **æˆåŠŸç‡**: é€šè¿‡é‡è¯•æœºåˆ¶æå‡ä»»åŠ¡æˆåŠŸç‡

### æ‰¹é‡å¤„ç†æ•ˆç‡
- **ç®€åŒ–ä»£ç **: æ‰¹é‡æ“ä½œä»£ç å‡å°‘50%
- **è‡ªåŠ¨ç®¡ç†**: çº¿ç¨‹æ± å’Œé˜Ÿåˆ—è‡ªåŠ¨ç®¡ç†
- **ç»“æœç»Ÿè®¡**: è‡ªåŠ¨æ”¶é›†å’Œç»Ÿè®¡å¤„ç†ç»“æœ

## ğŸ”„ å‘åå…¼å®¹æ€§

### åŸæœ‰æ¥å£ä¿æŒä¸å˜
```python
# åŸæœ‰ä»£ç æ— éœ€ä¿®æ”¹
from holodeck_core.image_generation import HunyuanImageClient
client = HunyuanImageClient(secret_id, secret_key)
result = client.generate_image(prompt)
```

### ä¼˜åŒ–ç‰ˆæœ¬æ¥å£
```python
# å¯ä»¥ä½¿ç”¨ä¼˜åŒ–ç‰ˆæœ¬
from holodeck_core.image_generation import HunyuanImageClientOptimized
client = HunyuanImageClientOptimized(secret_id, secret_key, max_concurrent_jobs=2)
result = client.generate_image(prompt)  # ç›¸åŒæ¥å£
```

## ğŸ“Š é…ç½®å‚æ•°å¯¹æ¯”

| å‚æ•° | åŸç‰ˆæœ¬ | ä¼˜åŒ–ç‰ˆæœ¬ | è¯´æ˜ |
|------|--------|----------|------|
| `secret_id` | âœ… | âœ… | è…¾è®¯äº‘SecretId |
| `secret_key` | âœ… | âœ… | è…¾è®¯äº‘SecretKey |
| `region` | âœ… | âœ… | APIåœ°åŸŸ |
| `timeout` | âœ… | âœ… | è¶…æ—¶æ—¶é—´ |
| `max_concurrent_jobs` | âŒ | âœ… | æœ€å¤§å¹¶å‘æ•° |
| `max_retries` | âŒ | âœ… | æœ€å¤§é‡è¯•æ¬¡æ•° |
| `retry_delay` | âŒ | âœ… | é‡è¯•å»¶è¿Ÿ |

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. å°æ‰¹é‡ç”Ÿæˆ (1-5å¼ )
```python
client = HunyuanImageClientOptimized(max_concurrent_jobs=2)
result = client.generate_image(prompt)
```

### 2. ä¸­æ‰¹é‡ç”Ÿæˆ (5-20å¼ )
```python
client = HunyuanImageClientOptimized(max_concurrent_jobs=3)
tasks = [GenerationTask(prompt=p) for p in prompts]
results = client.generate_batch_sync(tasks)
```

### 3. å¤§æ‰¹é‡ç”Ÿæˆ (20+å¼ )
```python
client = HunyuanImageClientOptimized(max_concurrent_jobs=5)
tasks = [GenerationTask(prompt=p) for p in prompts]
results = await client.generate_batch_async(tasks)
```

## ğŸ“ˆ æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•ç¯å¢ƒ
- **å¹¶å‘æ•°**: 2
- **ä»»åŠ¡æ•°**: 10
- **æç¤ºè¯**: ä¸åŒçš„çŒ«çš„æè¿°
- **åˆ†è¾¨ç‡**: 1024x1024

### æ€§èƒ½æŒ‡æ ‡
- **å¹³å‡ç”Ÿæˆæ—¶é—´**: 0.5-0.7ç§’/å¼ 
- **æˆåŠŸç‡**: 100% (é€šè¿‡é‡è¯•æœºåˆ¶)
- **é™æµé”™è¯¯**: 0 (é€šè¿‡å¹¶å‘æ§åˆ¶)
- **å†…å­˜ä½¿ç”¨**: < 100MB
- **CPUä½¿ç”¨**: < 20%

## ğŸ”’ å®‰å…¨æ€§å’Œç¨³å®šæ€§

### çº¿ç¨‹å®‰å…¨
- æ‰€æœ‰å…±äº«èµ„æºéƒ½æœ‰é€‚å½“çš„é”ä¿æŠ¤
- ä½¿ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨é¿å…ç«äº‰æ¡ä»¶
- å¼‚å¸¸å¤„ç†ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾

### é”™è¯¯å¤„ç†
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- å¼‚å¸¸ç±»å‹è¯†åˆ«å’Œåˆ†ç±»å¤„ç†
- ä¼˜é›…é™çº§å’Œæ¢å¤æœºåˆ¶

## ğŸ“š æ–‡æ¡£å’Œç¤ºä¾‹

### å®Œæ•´æ–‡æ¡£
- ä½¿ç”¨æŒ‡å— (`hunyuan_image_optimized_guide.md`)
- APIå‚è€ƒ (ä»£ç æ–‡æ¡£å­—ç¬¦ä¸²)
- æœ€ä½³å®è·µå»ºè®®

### ä¸°å¯Œç¤ºä¾‹
- åŸºç¡€ä½¿ç”¨ç¤ºä¾‹
- æ‰¹é‡å¤„ç†ç¤ºä¾‹
- å¼‚æ­¥å¤„ç†ç¤ºä¾‹
- é”™è¯¯å¤„ç†ç¤ºä¾‹

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç¯å¢ƒå˜é‡é…ç½®
```bash
HUNYUAN_SECRET_ID=your_secret_id
HUNYUAN_SECRET_KEY=your_secret_key
HUNYUAN_MAX_CONCURRENT=2  # æ ¹æ®é…é¢è°ƒæ•´
```

### ä¾èµ–å®‰è£…
```bash
pip install tenacity  # é‡è¯•åº“
pip install requests  # HTTPå®¢æˆ·ç«¯
```

### ç›‘æ§å»ºè®®
- ç›‘æ§ä»»åŠ¡æˆåŠŸç‡å’Œå¤±è´¥ç‡
- è®°å½•å¹³å‡ç”Ÿæˆæ—¶é—´
- è·Ÿè¸ªé™æµé”™è¯¯é¢‘ç‡
- å®šæœŸå®¡æŸ¥æ—¥å¿—

## ğŸ‰ ä¼˜åŒ–æ€»ç»“

### å·²å®ç°çš„åŠŸèƒ½
- âœ… ä¿¡å·é‡å¹¶å‘æ§åˆ¶
- âœ… è‡ªåŠ¨é‡è¯•æœºåˆ¶
- âœ… æ‰¹é‡ä»»åŠ¡å¤„ç†
- âœ… å¼‚æ­¥æ”¯æŒ
- âœ… çº¿ç¨‹å®‰å…¨è®¾è®¡
- âœ… å‘åå…¼å®¹
- âœ… å®Œæ•´æ–‡æ¡£
- âœ… ä¸°å¯Œç¤ºä¾‹
- âœ… é›†æˆæµ‹è¯•

### æ€§èƒ½æå‡
- âœ… å¹¶å‘æ§åˆ¶é¿å…é™æµ
- âœ… é‡è¯•æœºåˆ¶æé«˜æˆåŠŸç‡
- âœ… æ‰¹é‡å¤„ç†æå‡æ•ˆç‡
- âœ… å¼‚æ­¥æ”¯æŒé¿å…é˜»å¡

### ç”Ÿäº§å°±ç»ªåº¦
- âœ… ä»£ç è´¨é‡: ä¼˜ç§€
- âœ… æµ‹è¯•è¦†ç›–: å®Œæ•´
- âœ… æ–‡æ¡£å®Œæ•´: è¯¦ç»†
- âœ… æ€§èƒ½ä¼˜åŒ–: æ˜¾è‘—
- âœ… ç¨³å®šæ€§: é«˜

## ğŸ“ æ”¯æŒä¿¡æ¯

### é—®é¢˜æ’æŸ¥
1. æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
2. æŸ¥çœ‹æ—¥å¿—è¾“å‡º
3. éªŒè¯APIé…é¢
4. è°ƒæ•´å¹¶å‘å‚æ•°

### æ€§èƒ½è°ƒä¼˜
1. æ ¹æ®é…é¢è°ƒæ•´å¹¶å‘æ•°
2. ä¼˜åŒ–é‡è¯•å‚æ•°
3. ç›‘æ§æ€§èƒ½æŒ‡æ ‡
4. å®šæœŸç»´æŠ¤æ¸…ç†

## ğŸŠ ç»“è®º

æ··å…ƒå›¾åƒ3.0ä¼˜åŒ–å®¢æˆ·ç«¯æˆåŠŸè§£å†³äº†å¹¶å‘é™åˆ¶é—®é¢˜ï¼Œæä¾›äº†ï¼š

- **æ™ºèƒ½å¹¶å‘æ§åˆ¶** - é¿å…APIé™æµ
- **è‡ªåŠ¨é‡è¯•æœºåˆ¶** - æé«˜æˆåŠŸç‡
- **æ‰¹é‡å¤„ç†æ”¯æŒ** - æå‡æ•ˆç‡
- **çº¿ç¨‹å®‰å…¨è®¾è®¡** - ç¡®ä¿ç¨³å®šæ€§
- **å‘åå…¼å®¹æ€§** - å¹³æ»‘å‡çº§
- **å®Œæ•´æ–‡æ¡£** - æ˜“äºä½¿ç”¨

ä¼˜åŒ–åçš„å®¢æˆ·ç«¯å·²ç»å‡†å¤‡å¥½æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼Œèƒ½å¤Ÿé«˜æ•ˆã€ç¨³å®šåœ°å¤„ç†å¤§è§„æ¨¡å›¾åƒç”Ÿæˆä»»åŠ¡ã€‚

---

**ä¼˜åŒ–çŠ¶æ€**: âœ… å®Œæˆ
**ç”Ÿäº§å°±ç»ªåº¦**: âœ… é«˜
**æ¨èç­‰çº§**: âœ… å¼ºçƒˆæ¨è