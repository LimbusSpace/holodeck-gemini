{% extends "base.html" %}

{% block content %}
<!-- Config Status -->
<div id="config-status" hx-get="/config/status" hx-trigger="load" hx-swap="innerHTML" class="mb-6"></div>

<template id="config-warning">
    <div class="bg-yellow-900/50 border border-yellow-600 rounded-lg p-4 mb-4">
        <h3 class="text-yellow-400 font-semibold mb-2">配置 API</h3>
        <p class="text-sm text-gray-300 mb-3" id="config-missing"></p>
        <details class="mb-2" open>
            <summary class="cursor-pointer text-blue-400">配置 API 密钥</summary>
            <form hx-post="/config/save" hx-target="#config-msg" hx-swap="innerHTML" class="mt-3 space-y-4">
                <!-- 图像生成配置 -->
                <div class="border-b border-gray-700 pb-3">
                    <h4 class="text-sm font-medium text-purple-400 mb-2">图像生成 (OpenAI/Gemini 通用)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-gray-400">协议</label>
                            <select name="image_protocol" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                                <option value="gemini">Gemini</option>
                                <option value="openai">OpenAI</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400">模型名称</label>
                            <input type="text" name="image_model" placeholder="nano-banana" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-400">Base URL</label>
                        <input type="text" name="image_url" placeholder="https://api.apiyi.com/v1beta/models" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-400">API Key</label>
                        <input type="password" name="image_key" placeholder="sk-..." class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    </div>
                </div>

                <!-- VLM 配置 -->
                <div class="border-b border-gray-700 pb-3">
                    <h4 class="text-sm font-medium text-purple-400 mb-2">VLM 物体解析 (OpenAI 通用)</h4>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-400">Base URL</label>
                        <input type="text" name="vlm_url" placeholder="https://generativelanguage.googleapis.com/v1beta" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-400">API Key</label>
                        <input type="password" name="vlm_key" placeholder="AIza..." class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-400">模型名称</label>
                        <input type="text" name="vlm_model" placeholder="gemini-3-pro-preview" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    </div>
                </div>

                <!-- Hunyuan 3D 配置 -->
                <div class="border-b border-gray-700 pb-3">
                    <h4 class="text-sm font-medium text-purple-400 mb-2">Hunyuan 3D (可选)</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-xs text-gray-400">Secret ID</label>
                            <input type="password" name="hunyuan_id" placeholder="AKIDxxx" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400">Secret Key</label>
                            <input type="password" name="hunyuan_key" placeholder="xxx" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                        </div>
                    </div>
                </div>

                <!-- 资产检索配置 -->
                <div class="border-b border-gray-700 pb-3">
                    <h4 class="text-sm font-medium text-purple-400 mb-2">CLIP 资产检索 (可选)</h4>
                    <div class="grid grid-cols-2 gap-2 items-center">
                        <div class="flex items-center">
                            <input type="checkbox" name="asset_retrieval" id="asset_retrieval" class="mr-2 w-4 h-4">
                            <label for="asset_retrieval" class="text-xs text-gray-400">启用资产检索</label>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-400">相似度阈值</label>
                            <input type="number" name="asset_threshold" step="0.05" min="0" max="1" placeholder="0.25" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                        </div>
                    </div>
                </div>

                <!-- 人工审查配置 -->
                <div class="pb-2">
                    <h4 class="text-sm font-medium text-purple-400 mb-2">人工审查 (可选)</h4>
                    <p class="text-xs text-gray-500 mb-2">选择需要暂停审查的阶段</p>
                    <div class="grid grid-cols-3 gap-2">
                        {% for stage in ['scene_ref', 'extract', 'cards', 'constraints', 'layout', 'assets'] %}
                        <label class="flex items-center text-xs text-gray-400">
                            <input type="checkbox" name="review_{{ stage }}" class="mr-1 w-3 h-3" {{ 'checked' if stage in config.review_stages else '' }}> {{ stage }}
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-4 rounded w-full">保存配置</button>
                <div id="config-msg"></div>
            </form>
        </details>
    </div>
</template>

<script>
document.body.addEventListener('htmx:afterRequest', function(e) {
    if (e.detail.pathInfo.requestPath === '/config/status') {
        const data = JSON.parse(e.detail.xhr.responseText);
        const container = document.getElementById('config-status');
        const missing = [];
        if (!data.image) missing.push('图像生成');
        if (!data.vlm) missing.push('VLM');
        if (missing.length > 0) {
            container.innerHTML = document.getElementById('config-warning').innerHTML;
            document.getElementById('config-missing').textContent = '缺少配置: ' + missing.join(', ');
        } else {
            let status = '✓ 图像生成已配置, VLM已配置';
            if (data.hunyuan) status += ', Hunyuan3D已配置';
            container.innerHTML = '<div class="text-green-400 text-sm mb-4">' + status + '</div>';
        }
    }
});
</script>

<div class="card p-8 mb-10">
    <form hx-post="/generate" hx-target="#result" hx-swap="innerHTML" class="space-y-6">
        <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Scene Description</label>
            <textarea name="text" rows="4" required
                class="input-field w-full resize-none"
                placeholder="A cozy living room with a plush sofa, wooden coffee table, and warm lighting..."></textarea>
        </div>

        <div class="grid grid-cols-3 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Style</label>
                <select name="style" class="input-field w-full">
                    <option value="realistic">Realistic</option>
                    <option value="cartoon">Cartoon</option>
                    <option value="anime">Anime</option>
                    <option value="cyberpunk">Cyberpunk</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Start From</label>
                <select name="from_stage" class="input-field w-full">
                    {% for stage in stages %}
                    <option value="{{ stage }}" {% if stage == "scene_ref" %}selected{% endif %}>{{ stage }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Stop After</label>
                <select name="until" class="input-field w-full">
                    {% for stage in stages %}
                    <option value="{{ stage }}" {% if stage == "assets" %}selected{% endif %}>{{ stage }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <button type="submit" class="btn-primary w-full">
            Generate Scene
        </button>
    </form>
</div>

<div id="result"></div>

{% if sessions %}
<div class="mt-12">
    <h2 class="text-xl font-semibold mb-6 text-gray-300">Recent Sessions</h2>
    <div class="space-y-3">
        {% for s in sessions %}
        <div class="session-item group">
            <div class="flex-1 min-w-0">
                <span class="text-xs text-gray-500 font-mono">{{ s.id[:8] }}</span>
                <p class="text-gray-300 truncate text-sm mt-1">{{ s.text }}</p>
            </div>
            <button hx-get="/result/{{ s.id }}" hx-target="#result"
                class="text-purple-400 hover:text-purple-300 text-sm font-medium opacity-0 group-hover:opacity-100 transition-opacity">
                View
            </button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
