<div id="progress" class="card p-8"
     hx-ext="sse"
     sse-connect="/stream/{{ session_id }}?text={{ text|urlencode }}&style={{ style }}&from_stage={{ from_stage }}&until={{ until }}"
     sse-swap="message">

    <div class="flex items-center mb-6">
        <div class="spinner mr-4"></div>
        <span class="text-lg font-medium">Starting pipeline...</span>
    </div>

    <div id="stages" class="space-y-3">
        <div class="text-gray-500 text-sm font-mono">Session: {{ session_id[:8] }}</div>
    </div>

    <div class="progress-bar mt-6">
        <div class="progress-bar-fill"></div>
    </div>

    <div id="review-panel" class="mt-6"></div>
</div>

<script>
document.body.addEventListener('sse:message', function(e) {
    const data = JSON.parse(e.detail.data);
    const stages = document.getElementById('stages');

    if (data.stage && data.status === 'running') {
        stages.innerHTML += `<div class="stage-item stage-running">
            <span class="stage-icon">&#9679;</span> ${data.stage}
        </div>`;
    } else if (data.stage && data.status === 'done') {
        const items = stages.querySelectorAll('.stage-item');
        const last = items[items.length - 1];
        if (last) {
            last.className = 'stage-item stage-done';
            last.innerHTML = `<span class="stage-icon">&#10003;</span> ${data.stage}`;
        }
    } else if (data.stage && data.status === 'review') {
        const items = stages.querySelectorAll('.stage-item');
        const last = items[items.length - 1];
        if (last) {
            last.className = 'stage-item stage-review';
            last.innerHTML = `<span class="stage-icon">&#9888;</span> ${data.stage} (审查中)`;
        }
        htmx.ajax('GET', '/review/' + data.session_id + '/' + data.stage, '#review-panel');
    } else if (data.status === 'complete') {
        htmx.ajax('GET', '/result/' + data.session_id, '#result');
    } else if (data.status === 'error') {
        stages.innerHTML += `<div class="stage-item stage-error">
            <span class="stage-icon">&#10007;</span> ${data.error}
        </div>`;
    }
});
</script>
